# Claude Shop 项目上下文记忆

## 📝 项目基本信息

**项目名称**: Claude Shop  
**项目类型**: 内部管理系统  
**主要功能**: AWS账号资源管理，Claude AI服务配额查看和账号销售管理  
**技术栈**: Ruby on Rails 8.0 + MySQL 8.0 + Tailwind CSS + Stimulus + ViewComponent  
**开发周期**: 4-6周 (预估42个工作日)  
**项目状态**: 架构设计完成，准备开始开发  

---

## 🎯 核心业务逻辑

### 用户角色
1. **公开用户**: 查看可购买的AWS账号信息，只读权限
2. **管理员**: 完整的系统管理权限，包括账号管理、配额更新、数据维护

### 核心功能模块
1. **公开展示系统**
   - 账号浏览功能 (卡片展示)
   - 高级筛选功能 (按模型、状态、配额筛选)
   - 详细信息查看 (弹窗或详情页)
   - Telegram集成 (联系购买)

2. **管理员后台系统**
   - 安全认证系统 (JWT + 防暴力破解)
   - 账号管理功能 (CRUD + 批量操作)
   - 配额刷新功能 (自动/手动/定时)
   - 审计日志功能 (完整操作记录)
   - 状态管理功能 (可用/售罄/维护/下架)

### 业务规则
1. **配额管理**: 自动获取AWS Claude模型配额信息，支持多种模型
2. **状态控制**: 支持4种状态 (available, sold_out, maintenance, offline)
3. **安全策略**: AWS密钥加密存储，操作审计，登录失败锁定
4. **数据同步**: 支持定时和手动刷新配额，保持数据实时性

---

## 🏗️ 技术架构详情

### 数据库设计
核心数据表设计完成，包含：
1. **admins** - 管理员表 (认证、权限、登录记录)
2. **aws_accounts** - AWS账号表 (账号信息、状态、连接状态)
3. **quotas** - 配额表 (模型配额、使用情况、更新状态)
4. **quota_histories** - 配额历史表 (配额变化记录)
5. **audit_logs** - 审计日志表 (操作记录、IP、时间)
6. **system_configs** - 系统配置表 (可配置参数)
7. **refresh_jobs** - 刷新任务表 (任务状态、进度跟踪)

### 架构特点
- **安全第一**: JWT认证、数据加密、审计跟踪、CSRF保护
- **性能优化**: 缓存策略、数据库索引、后台任务处理
- **现代技术栈**: Rails 8.0 + Hotwire (Turbo + Stimulus)
- **组件化**: ViewComponent提高代码复用性
- **响应式设计**: Tailwind CSS确保移动端体验

### 目录结构
```
app/
├── controllers/          # 控制器 (公开+管理员)
├── models/              # 数据模型
├── views/               # 视图模板
├── components/          # ViewComponent组件
├── services/            # 业务逻辑服务
├── jobs/                # 后台任务
├── mailers/             # 邮件服务
└── helpers/             # 辅助方法
```

---

## 🔧 开发规范与约定

### 代码风格
- 遵循Rails最佳实践和约定
- 使用RuboCop进行代码质量检查
- Model验证完整，Controller职责单一
- Service层处理复杂业务逻辑

### 安全规范
1. **数据保护**: AWS密钥使用attr_encrypted加密存储
2. **输入验证**: 所有用户输入严格验证和过滤
3. **权限控制**: 基于JWT的认证授权机制
4. **审计跟踪**: 所有关键操作记录审计日志
5. **会话管理**: Token自动过期和刷新机制

### 性能规范
1. **数据库优化**: 合理索引设计，避免N+1查询
2. **缓存策略**: 页面缓存和数据缓存结合使用
3. **后台任务**: 耗时操作使用Solid Queue处理
4. **API响应**: 目标响应时间<1秒，页面加载<3秒

---

## 📋 当前开发状态

### 已完成 (2025-07-25)
- [x] 完整的项目架构设计
- [x] 数据库结构设计和Migration文件
- [x] 路由架构设计
- [x] MVC架构规划和示例代码
- [x] 项目管理体系建立 (路线图、进度追踪、任务清单)

### 下一步计划 (2025-07-26)
- [ ] Rails项目初始化
- [ ] Docker开发环境搭建
- [ ] 数据库迁移执行
- [ ] 基础Gems配置
- [ ] JWT认证系统实现

### 里程碑进度
- **M1: 架构完成** (预计Day 7) - ✅ 提前完成 (Day 1)
- **M2: AWS集成** (预计Day 14) - 📅 计划中
- **M3: 管理后台** (预计Day 21) - 📅 计划中
- **M4: 公开展示** (预计Day 28) - 📅 计划中
- **M5: 用户体验** (预计Day 35) - 📅 计划中
- **M6: 生产就绪** (预计Day 42) - 📅 计划中

---

## 🔍 技术难点与解决方案

### 已识别的技术挑战
1. **AWS API集成复杂性**
   - 问题: Service Quotas API调用和使用量统计
   - 解决方案: 分阶段实现，先实现基础配额获取，再完善使用量统计

2. **敏感数据加密存储**
   - 问题: AWS密钥的安全存储和使用
   - 解决方案: 使用attr_encrypted gem，配合Rails credentials

3. **实时配额更新**
   - 问题: 配额数据的实时性和准确性
   - 解决方案: 结合定时任务和手动刷新，使用Action Cable推送更新

4. **高并发场景下的性能**
   - 问题: 多用户同时查看和刷新配额
   - 解决方案: Redis缓存 + 数据库读写分离 + CDN静态资源

### 技术选择理由
1. **Rails 8.0**: 最新稳定版本，内置Solid Queue和改进的缓存机制
2. **MySQL 8.0**: 稳定可靠，支持JSON字段，性能优秀
3. **ViewComponent**: 提高组件复用性，便于维护
4. **Tailwind CSS**: 快速开发，响应式设计，文件体积小
5. **JWT**: 无状态认证，适合API和现代前端架构

---

## 📊 项目度量标准

### 性能指标
- 页面首次加载时间 < 3秒
- API响应时间 < 1秒
- 配额刷新操作 < 30秒
- 系统可用性 > 99%

### 质量指标
- 测试覆盖率 > 80%
- 代码质量评级 > A
- 安全扫描无高危漏洞
- 用户体验评分 > 4.5/5

### 业务指标
- 管理员操作效率提升 50%
- 客户查询响应时间减少 70%
- 配额信息准确率 > 99%
- 客户满意度 > 90%

---

## 🚨 风险管控

### 高风险项
1. **AWS API依赖风险**
   - 描述: AWS API变更或限制影响功能
   - 应对: 版本锁定 + 备用方案 + 监控告警

2. **数据安全风险**
   - 描述: AWS密钥泄露或非法访问
   - 应对: 加密存储 + 访问控制 + 审计日志

3. **性能瓶颈风险**
   - 描述: 用户增长导致系统响应变慢
   - 应对: 性能监控 + 缓存优化 + 水平扩展

### 中等风险项
1. **第三方依赖风险**: 定期更新依赖，使用Dependabot监控
2. **数据一致性风险**: 事务处理 + 数据校验 + 定期对账
3. **用户体验风险**: 用户测试 + A/B测试 + 持续改进

---

## 📝 开发备忘录

### 重要提醒
1. **安全优先**: 所有AWS密钥都必须加密存储，绝不能以明文形式出现在日志中
2. **操作审计**: 所有管理员操作都必须记录审计日志，包括IP、时间、操作内容
3. **错误处理**: 所有外部API调用都要有完善的错误处理和重试机制
4. **数据验证**: 用户输入必须严格验证，防止SQL注入和XSS攻击

### 编码约定
1. **命名规范**: 使用语义化命名，类名大驼峰，方法名小驼峰加下划线
2. **注释规范**: 复杂业务逻辑必须有详细注释，API方法要有参数说明
3. **测试规范**: 关键业务逻辑测试覆盖率100%，边界条件必须测试
4. **文档规范**: README更新及时，API文档自动生成

### 性能优化
1. **查询优化**: 合理使用includes避免N+1查询
2. **缓存策略**: 静态数据缓存5分钟，动态数据缓存1分钟
3. **图片优化**: 使用WebP格式，启用CDN加速
4. **JS优化**: 代码分割，按需加载，启用压缩

---

## 🔄 项目状态更新记录

### 2025-07-25 (Day 1)
- ✅ 完成项目架构设计
- ✅ 完成数据库设计
- ✅ 完成MVC架构规划
- ✅ 建立项目管理体系
- 📋 下一步: Rails项目初始化

### 待更新...
(每日开发结束后更新此部分)

---

## 📞 联系与协作

### 项目相关人员
- **开发者**: 项目开发者
- **产品负责人**: 需求定义和验收
- **技术架构师**: 架构设计和技术选型

### 沟通渠道
- **日常沟通**: Claude Code对话
- **文档协作**: 项目GitHub仓库
- **进度同步**: 每日进度文档更新

### 问题反馈
- **技术问题**: 在代码中添加TODO注释或GitHub Issues
- **需求变更**: 更新PRD文档并同步相关人员
- **紧急问题**: 立即在项目群组中同步

---

**文档创建时间**: 2025-07-25 12:46  
**最后更新时间**: 2025-07-25 12:46  
**文档版本**: v1.0  
**维护人**: Claude Code Assistant