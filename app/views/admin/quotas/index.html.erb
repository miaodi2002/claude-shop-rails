<%# Admin Quota Management Index %>
<div class="bg-white">
  <div class="px-4 py-5 border-b border-gray-200 sm:px-6">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold leading-tight text-gray-900">配额管理</h1>
        <p class="mt-1 text-sm text-gray-500">管理AWS账号的Claude模型配额使用情况</p>
      </div>
      <div class="flex space-x-3">
        <%= link_to '配额统计', statistics_admin_quotas_path, 
            class: "inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50" %>
        <%= link_to '导出数据', export_admin_quotas_path(format: :csv), 
            class: "inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50" %>
        <button onclick="bulkRefresh()" 
                class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
          批量刷新
        </button>
      </div>
    </div>
  </div>

  <!-- 配额摘要统计 -->
  <div class="px-6 py-6 border-b border-gray-200">
    <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                </svg>
              </div>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">总配额数</dt>
                <dd class="text-lg font-medium text-gray-900"><%= @quota_summary[:total_quotas] %></dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
              </div>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">高配额</dt>
                <dd class="text-lg font-medium text-gray-900"><%= @quota_summary[:high_quota_count] %></dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-yellow-500 rounded-md flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
              </div>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">低配额</dt>
                <dd class="text-lg font-medium text-gray-900"><%= @quota_summary[:low_quota_count] %></dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-red-500 rounded-md flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
              </div>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">更新失败</dt>
                <dd class="text-lg font-medium text-gray-900"><%= @quota_summary[:failed_count] %></dd>
              </dl>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 搜索和过滤 -->
  <div class="px-6 py-4 border-b border-gray-200">
    <%= form_with url: admin_quotas_path, method: :get, local: true, class: "space-y-4" do |form| %>
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
        <div>
          <%= form.text_field :search, 
              placeholder: "搜索账号名称、模型...", 
              value: params[:search],
              class: "block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" %>
        </div>
        
        <div>
          <%= form.select :service_name, 
              options_for_select([
                ['所有服务', 'all'],
                ['Claude-3.5-Sonnet', 'Claude-3.5-Sonnet'],
                ['Claude-3-Haiku', 'Claude-3-Haiku'],
                ['Claude-3-Opus', 'Claude-3-Opus']
              ], params[:service_name]),
              {},
              { class: "block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" } %>
        </div>
        
        <div>
          <%= form.select :status_filter, 
              options_for_select([
                ['所有状态', 'all'],
                ['高配额', 'high'],
                ['低配额', 'low']
              ], params[:status_filter]),
              {},
              { class: "block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" } %>
        </div>
        
        <div>
          <%= form.select :update_status, 
              options_for_select([
                ['所有更新状态', 'all'],
                ['成功', 'success'],
                ['失败', 'failed'],
                ['待更新', 'pending']
              ], params[:update_status]),
              {},
              { class: "block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" } %>
        </div>
      </div>
      
      <div class="flex justify-end">
        <%= form.submit "搜索", class: "inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700" %>
        <%= link_to "重置", admin_quotas_path, class: "ml-3 inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50" %>
      </div>
    <% end %>
  </div>

  <!-- 配额列表 -->
  <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
    <div class="min-w-full divide-y divide-gray-300">
      <div class="bg-gray-50">
        <div class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider grid grid-cols-12 gap-4 items-center">
          <div class="col-span-1">
            <input type="checkbox" id="select-all" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
          </div>
          <div class="col-span-2">AWS账号</div>
          <div class="col-span-2">模型名称</div>
          <div class="col-span-1">配额类型</div>
          <div class="col-span-1">配额限制</div>
          <div class="col-span-1">默认值</div>
          <div class="col-span-1">配额等级</div>
          <div class="col-span-1">更新状态</div>
          <div class="col-span-1">最后更新</div>
          <div class="col-span-1">操作</div>
        </div>
      </div>
      <div class="bg-white divide-y divide-gray-200">
        <% @quotas.each do |quota| %>
          <div class="px-6 py-4 grid grid-cols-12 gap-4 items-center hover:bg-gray-50">
            <div class="col-span-1">
              <input type="checkbox" name="quota_ids[]" value="<%= quota.id %>" 
                     class="quota-checkbox h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
            </div>
            
            <div class="col-span-2">
              <div class="text-sm font-medium text-gray-900">
                <%= link_to quota.aws_account.name, account_quotas_admin_aws_account_path(quota.aws_account), 
                    class: "text-indigo-600 hover:text-indigo-900" %>
              </div>
              <div class="text-sm text-gray-500"><%= quota.aws_account.account_id %></div>
            </div>
            
            <div class="col-span-2">
              <div class="text-sm font-medium text-gray-900"><%= quota.service_name %></div>
            </div>
            
            <div class="col-span-1">
              <div class="text-xs text-blue-600"><%= quota.quota_type_description %></div>
            </div>
            
            <div class="col-span-1">
              <div class="text-sm text-gray-900"><%= quota.formatted_limit_value %></div>
            </div>
            
            <div class="col-span-1">
              <div class="text-sm text-gray-600"><%= quota.formatted_default_value %></div>
            </div>
            
            <div class="col-span-1">
              <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                <%= case quota.quota_level
                    when 'high' then 'bg-green-100 text-green-800'
                    when 'low' then 'bg-red-100 text-red-800'
                    else 'bg-gray-100 text-gray-800'
                    end %>">
                <%= quota.level_icon %> 
                <%= quota.quota_level&.upcase || 'N/A' %>
              </span>
            </div>
            
            <div class="col-span-1">
              <% case quota.update_status %>
              <% when 'success' %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">成功</span>
              <% when 'failed' %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">失败</span>
              <% when 'pending' %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">待更新</span>
              <% end %>
            </div>
            
            <div class="col-span-1">
              <div class="text-sm text-gray-500">
                <%= quota.last_updated_at&.strftime('%m-%d %H:%M') || '未更新' %>
              </div>
            </div>
            
            <div class="col-span-1">
              <div class="flex items-center space-x-2">
                <%= link_to admin_quota_path(quota), 
                    class: "text-indigo-600 hover:text-indigo-900 text-sm" do %>
                  查看
                <% end %>
                <%= link_to refresh_admin_quota_path(quota), method: :post,
                    data: { confirm: '确定要刷新此配额吗？' },
                    class: "text-green-600 hover:text-green-900 text-sm" do %>
                  刷新
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- 分页 -->
  <% if @quotas.respond_to?(:current_page) %>
    <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
      <div class="flex-1 flex justify-between sm:hidden">
        <% if @quotas.prev_page %>
          <%= link_to "上一页", admin_quotas_path(page: @quotas.prev_page), 
              class: "relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" %>
        <% end %>
        <% if @quotas.next_page %>
          <%= link_to "下一页", admin_quotas_path(page: @quotas.next_page), 
              class: "ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" %>
        <% end %>
      </div>
      <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
        <div>
          <p class="text-sm text-gray-700">
            显示 <span class="font-medium"><%= (@quotas.current_page - 1) * @quotas.limit_value + 1 %></span> 到 
            <span class="font-medium"><%= [@quotas.current_page * @quotas.limit_value, @quotas.total_count].min %></span> 条，
            共 <span class="font-medium"><%= @quotas.total_count %></span> 条记录
          </p>
        </div>
        <div>
          <%= paginate @quotas if defined?(Kaminari) %>
        </div>
      </div>
    </div>
  <% end %>
</div>

<script>
// 全选功能
document.addEventListener('DOMContentLoaded', function() {
  const selectAllCheckbox = document.getElementById('select-all');
  const quotaCheckboxes = document.querySelectorAll('.quota-checkbox');
  
  selectAllCheckbox.addEventListener('change', function() {
    quotaCheckboxes.forEach(checkbox => {
      checkbox.checked = selectAllCheckbox.checked;
    });
  });
  
  quotaCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const checkedBoxes = document.querySelectorAll('.quota-checkbox:checked');
      selectAllCheckbox.checked = checkedBoxes.length === quotaCheckboxes.length;
      selectAllCheckbox.indeterminate = checkedBoxes.length > 0 && checkedBoxes.length < quotaCheckboxes.length;
    });
  });
});

// 批量刷新功能
function bulkRefresh() {
  const checkedBoxes = document.querySelectorAll('.quota-checkbox:checked');
  
  if (checkedBoxes.length === 0) {
    alert('请选择要刷新的配额');
    return;
  }
  
  if (!confirm(`确定要刷新选中的 ${checkedBoxes.length} 个配额吗？`)) {
    return;
  }
  
  const quotaIds = Array.from(checkedBoxes).map(box => box.value);
  
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '<%= bulk_refresh_admin_quotas_path %>';
  
  // Add CSRF token
  const csrfToken = document.querySelector('[name="csrf-token"]').getAttribute('content');
  const csrfInput = document.createElement('input');
  csrfInput.type = 'hidden';
  csrfInput.name = 'authenticity_token';
  csrfInput.value = csrfToken;
  form.appendChild(csrfInput);
  
  // Add quota IDs
  quotaIds.forEach(id => {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'quota_ids[]';
    input.value = id;
    form.appendChild(input);
  });
  
  document.body.appendChild(form);
  form.submit();
}
</script>